<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano 33 BLE ì•Œë¦¼ ìˆ˜ì‹ </title>
    <style>
        body { 
            font-family: 'Unbounded', sans-serif; 
            text-align: center; 
            padding: 30px; 
            background-color: #f4f4f4;
        }
        h1 { margin-bottom: 30px; font-size: 24px; }
        
        button { 
            padding: 20px 40px; 
            font-size: 18px; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
        }
        button:active { background-color: #0056b3; }

        #status { 
            margin-top: 40px; 
            font-size: 20px; 
            font-weight: bold; 
            color: #555; 
            padding: 20px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* ì•Œë¦¼ ìš¸ë¦´ ë•Œ í™”ë©´ íš¨ê³¼ */
        .alert-mode {
            background-color: #ff4444 !important;
            color: white !important;
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>

    <h1>ğŸ”” Nano 33 BLE ìˆ˜ì‹ ê¸°</h1>
    
    <button id="connectBtn">ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°í•˜ê¸°</button>
    
    <div id="status">ì—°ê²° ëŒ€ê¸° ì¤‘...</div>

    <script>
        // =================================================================
        // [ì¤‘ìš”] ì•„ë‘ì´ë…¸ ì½”ë“œì— ì ì€ UUIDì™€ ë˜‘ê°™ì´ ì ì–´ì•¼ í•©ë‹ˆë‹¤.
        // (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ, ì•„ë‘ì´ë…¸ ì½”ë“œ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”)
        // =================================================================
        const serviceUUID = "19b10000-e8f2-537e-4f6c-d104768a7777"; 
        const charUUID    = "19c10001-e8f2-537e-4f6c-d104768a7777";

        const connectBtn = document.getElementById('connectBtn');
        const statusDiv = document.getElementById('status');

        connectBtn.addEventListener('click', async () => {
            try {

                // 0. ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ (ìƒë‹¨ ë°°ë„ˆìš©)
                if (Notification.permission !== 'granted') {
                    await Notification.requestPermission();
                }
                // 1. ì¥ì¹˜ ê²€ìƒ‰
                statusDiv.innerText = "ğŸ” ì¥ì¹˜ ê²€ìƒ‰ ì¤‘...";
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [serviceUUID] }]
                });

                // 2. ì—°ê²° ì‹œë„
                statusDiv.innerText = "ğŸ”— ì—°ê²° ì¤‘...";
                const server = await device.gatt.connect();
                
                // 3. ì„œë¹„ìŠ¤ ë° íŠ¹ì„± ê°€ì ¸ì˜¤ê¸°
                const service = await server.getPrimaryService(serviceUUID);
                const characteristic = await service.getCharacteristic(charUUID);

                // 4. ì•Œë¦¼(Notify) í™œì„±í™”
                await characteristic.startNotifications();
                statusDiv.innerText = "âœ… ì—°ê²°ë¨! (ì‹ í˜¸ ëŒ€ê¸° ì¤‘)";
                
                // 5. ë°ì´í„° ìˆ˜ì‹  ì‹œ ë™ì‘ (í•µì‹¬ ë¡œì§)
                characteristic.addEventListener('characteristicvaluechanged', (event) => {
                    // ë°ì´í„° ì½ê¸° (1ë°”ì´íŠ¸ ì •ìˆ˜)
                    const value = event.target.value.getUint8(0); 
                    console.log("ë°›ì€ ê°’:", value);

                    if (value === 1) {
                        // ğŸš¨ ê°’ 1ì„ ë°›ìœ¼ë©´: í™”ë©´ ë¹¨ê°›ê²Œ + ì§„ë™
                        statusDiv.innerText = "ğŸš¨ ì•Œë¦¼ ìˆ˜ì‹ ! (ê°’: 1)";
                        statusDiv.className = "alert-mode"; // ë¹¨ê°„ í™”ë©´ íš¨ê³¼ ì¼¬
                        
                        // ì§„ë™ ìš¸ë¦¬ê¸° (1ì´ˆ ì§•- 0.2ì´ˆ ì‰¼ 1ì´ˆ ì§•-)
                        // ì£¼ì˜: ì•„ì´í°(iOS)ì€ ì •ì±…ìƒ ì›¹ ì§„ë™ì„ ë§‰ì•„ë†”ì„œ ì•ˆ ìš¸ë¦´ ìˆ˜ ìˆìŒ
                        if (navigator.vibrate) {
                            navigator.vibrate([1000, 200, 1000]); 
                        }

                        // â˜… ìƒë‹¨ ì‹œìŠ¤í…œ ë°°ë„ˆ ì•Œë¦¼ ë„ìš°ê¸° (ë°±ê·¸ë¼ìš´ë“œì¼ ë•Œ ê·¸ë‚˜ë§ˆ ë„ì›€ë¨)
                        if (Notification.permission === "granted") {
                            new Notification("ğŸš¨ ê¸´ê¸‰ ì•Œë¦¼", {
                                body: "ì¶©ê²©ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!",
                                icon: "https://cdn-icons-png.flaticon.com/512/564/564619.png" // ê²½ê³  ì•„ì´ì½˜ ì˜ˆì‹œ
                            });
                        }

                    } else {
                        // ê°’ì´ 1ì´ ì•„ë‹ˆë©´(0 ë“±): ì •ìƒ ìƒíƒœë¡œ ë³µê·€
                        statusDiv.innerText = "âœ… ì •ìƒ (ì‹ í˜¸ ëŒ€ê¸° ì¤‘)";
                        statusDiv.className = ""; // íš¨ê³¼ ë”
                    }
                });

                // ì—°ê²° ëŠê²¼ì„ ë•Œ ì²˜ë¦¬
                device.addEventListener('gattserverdisconnected', () => {
                    statusDiv.innerText = "âŒ ì—°ê²° ëŠê¹€";
                    statusDiv.className = "";
                    alert("ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.");
                });

            } catch (error) {
                console.error(error);
                statusDiv.innerText = "ì—ëŸ¬ ë°œìƒ: " + error;
                // ì‚¬ìš©ìê°€ ì·¨ì†Œí–ˆì„ ë•ŒëŠ” ì¡°ìš©íˆ ë„˜ì–´ê°€ê¸°
                if (!error.toString().includes("cancelled")) {
                    alert("ì—°ê²° ì‹¤íŒ¨! ì•„ë‘ì´ë…¸ ì „ì›ê³¼ UUIDë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                }
            }
        });
    </script>
</body>
</html>
